<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="sidebar-header">
                <img src="/static/img/logoss.png" alt="Logo" class="logo">
                <h4>Admin Panel</h4>
            </div>
            
            <ul class="sidebar-nav">
                <li>
                    <a href="{{ url_for('admin.admin_dashboard') }}">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin.admin_analysis') }}">
                        <i class="fas fa-chart-bar"></i> Crime Analysis
                    </a>
                </li>
                <li class="active">
                    <a href="{{ url_for('admin.admin_logs') }}">
                        <i class="fas fa-clipboard-list"></i> Activity Logs
                    </a>
                </li>
                {% if session.get('is_superadmin') %}
                <li>
                    <a href="{{ url_for('admin.admin_settings') }}">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </li>
                {% endif %}
                <li>
                    <a href="{{ url_for('admin.admin_logout') }}">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <p>Logged in as: <strong>{{ session.get('admin_name') }}</strong></p>
                {% if session.get('is_superadmin') %}
                <span class="badge bg-primary">Super Admin</span>
                {% else %}
                <span class="badge bg-secondary">Admin</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main">
            <div class="admin-header">
                <h2><i class="fas fa-clipboard-list"></i> Activity Logs</h2>
                <div class="time-filter">
                    <select class="form-select" id="timeFilter">
                        <option value="all">All Time</option>
                        <option value="7days">Last 7 Days</option>
                        <option value="30days">Last 30 Days</option>
                    </select>
                </div>
            </div>
            
            <!-- Tabs -->
            <ul class="nav nav-tabs" id="logsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="user-logs-tab" data-bs-toggle="tab" data-bs-target="#user-logs" type="button" role="tab">
                        User Logs ({{ user_logs|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admin-logs-tab" data-bs-toggle="tab" data-bs-target="#admin-logs" type="button" role="tab">
                        Admin Logs ({{ admin_logs|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="blocked-users-tab" data-bs-toggle="tab" data-bs-target="#blocked-users" type="button" role="tab">
                        Blocked Users ({{ blocked_users|length }})
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="logsTabsContent">
                <!-- User Logs Tab -->
                <div class="tab-pane fade show active" id="user-logs" role="tabpanel">
                    <div class="table-responsive">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>IP Address</th>
                                    <th>Location</th>
                                    <th>Device</th>
                                    <th>Timestamp</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in user_logs %}
                                <tr>
                                    <td>
                                        {% if log.user_id %}
                                            {{ log.fname }} {{ log.lname }}
                                            <small>{{ log.email }}</small>
                                        {% else %}
                                            System Generated
                                        {% endif %}
                                    </td>
                                    <td>{{ log.action }}</td>
                                    <td>{{ log.ip_address }}</td>
                                    <td>{{ log.location or 'N/A' }}</td>
                                    <td>{{ log.device_info }}</td>
                                    <td>{{ log.created_at }}</td>
                                    <td>
                                        {% if log.user_id %}
                                            {% if log.user_id in blocked_users %}
                                                <span class="badge bg-danger">Blocked</span>
                                            {% else %}
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="blockUser({{ log.user_id }}, '{{ log.fname|default('User') }} {{ log.lname|default('') }}')">
                                                    <i class="fas fa-ban"></i> Block
                                                </button>
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">No user activity logs found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Admin Logs Tab -->
                <div class="tab-pane fade" id="admin-logs" role="tabpanel">
                    <div class="table-responsive">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>Admin</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                    <th>Device</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in admin_logs %}
                                <tr>
                                    <td>{{ log.full_name }}</td>
                                    <td>{{ log.action }}</td>
                                    <td>
                                        {% if log.details %}
                                        <button class="btn btn-sm btn-info" onclick="showDetails({{ log.details|tojson }})">
                                            <i class="fas fa-info-circle"></i> View
                                        </button>
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ log.ip_address }}</td>
                                    <td>
                                        {% set ua = parse_user_agent(log.user_agent) %}
                                        {{ ua.browser }} on {{ ua.os }}
                                    </td>
                                    <td>{{ log.created_at }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Blocked Users Tab -->
                <div class="tab-pane fade" id="blocked-users" role="tabpanel">
                    <div class="table-responsive">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Blocked By</th>
                                    <th>Reason</th>
                                    <th>Date Blocked</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_id, user in blocked_users.items() %}
                                <tr>
                                    <td>
                                        {{ user.fname }} {{ user.lname }}
                                        <small>{{ user.email }}</small>
                                    </td>
                                    <td>{{ user.blocked_by }}</td>
                                    <td>{{ user.reason or 'No reason provided' }}</td>
                                    <td>{{ user.created_at }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" 
                                                onclick="unblockUser({{ user_id }}, '{{ user.fname }} {{ user.lname }}')">
                                            <i class="fas fa-check"></i> Unblock
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">No blocked users found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Action Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="detailsContent"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Block User Modal -->
    <div class="modal fade" id="blockUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Block User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="blockUserMessage"></p>
                    <div class="form-group">
                        <label for="blockReason">Reason (optional)</label>
                        <textarea class="form-control" id="blockReason" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmBlock">Confirm Block</button>
                </div>
            </div>
        </div>
    </div>
    
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <script src="/static/js/admin_script.js"></script>
</body>
</html>
