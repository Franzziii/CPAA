<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crime Records Dashboard</title>
    <link rel="stylesheet" href="/static/css/dashb.css">
    <script src="static/js/script.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-logo">
            <img src="/static/img/logoss.png" alt="Logo" class="logo">
        </div>
        <div class="header-icons">
            <a href="/index" class="btn btn-primary back-arrow"><i class="fas fa-home"></i> <span class="btn-text">Home</span></a>
            <a href="/logout" class="btn btn-danger logout-btn"><i class="fas fa-sign-out-alt"></i> <span class="btn-text">Logout</span></a>
        </div>
        </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="dashboard-header">
            <h2>Crime Reports Dashboard</h2>
            <div class="action-buttons">
                <a href="{{ url_for('user_analytics') }}" class="btn btn-info"><i class="fas fa-chart-bar"></i> <span class="btn-text">Analytics</span></a>
                <i class="fas fa-bell header-icon"></i>
            </div>
        </div>

        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search reports..." oninput="applyFiltersAndPagination()">
        </div>

        <div class="table-responsive-container">
            <div class="table-card">
                <article class="table-widget">
                    <div class="caption">
                        <h2>Crime Reports</h2>
                        <div class="table-actions">
                            <span id="reportCount">0 reports</span>
                        </div>
                    </div>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th class="resizable" data-column="0" onclick="sortTable(0)">Incident Type</th>
                                <th class="resizable" data-column="1" onclick="sortTable(1)">Location</th>
                                <th class="resizable" data-column="2" onclick="sortTable(2)">Date</th>
                                <th class="resizable" data-column="3" onclick="sortTable(3)">Status</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            {% if reports %}
                                {% for report in reports %}
                                <tr>
                                    <td data-label="Type">{{ report.incident_type }}</td>
                                    <td data-label="Location">
                                        <a href="http://maps.google.com/?q={{ report.latitude }},{{ report.longitude }}" target="_blank">
                                            {{ report.location }}
                                        </a>
                                    </td>
                                    <td data-label="Date">{{ report.report_date }}</td>
                                    <td data-label="Status">
                                        <div class="status status-{{ report.status|lower|replace(' ', '-') }}">
                                            {{ report.status }}
                                        </div>
                                        {% if report.admin_feedback %}
                                        <div class="feedback-tooltip">
                                            <i class="fas fa-comment-alt"></i>
                                            <span class="tooltip-text">{{ report.admin_feedback }}</span>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="no-print actions-cell" data-label="Actions">
                                        <a href="{{ url_for('edit_report', report_id=report.id) }}" class="btn btn-success edit-btn" title="View Status">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('delete_report', report_id=report.id) }}" class="btn btn-danger delete-btn" title="Delete" onclick="return confirm('Are you sure you want to delete this report? This action cannot be undone.');">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">No crime reports yet.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </article>
            </div>
        </div>

        <div class="pagination">
            <button id="prevPage" class="btn btn-secondary pagination-btn"><i class="fas fa-chevron-left"></i> <span class="btn-text">Prev</span></button>
            <span id="pageInfo"></span>
            <button id="nextPage" class="btn btn-secondary pagination-btn"><span class="btn-text">Next</span> <i class="fas fa-chevron-right"></i></button>
        </div>
    </main>

    <footer class="footer">
        <p>Â© 2025 Crime Prevention App and Analysis. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Dashboard script loaded and DOMContentLoaded fired.");
            // Initial call to apply both filter and pagination
            applyFiltersAndPagination();
            
            // Make table columns resizable
            document.querySelectorAll('#reportTable th.resizable').forEach(th => {
                let startX, startWidth;

                const resizer = document.createElement('div');
                resizer.style.width = '5px';
                resizer.style.height = '100%';
                resizer.style.position = 'absolute';
                resizer.style.top = '0';
                resizer.style.right = '0';
                resizer.style.background = 'rgba(0, 0, 0, 0.1)';
                resizer.style.cursor = 'col-resize';
                th.style.position = 'relative';

                resizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.pageX;
                    startWidth = parseInt(document.defaultView.getComputedStyle(th).width, 10);
                    document.documentElement.addEventListener('mousemove', onMouseMove);
                    document.documentElement.addEventListener('mouseup', onMouseUp);
                    e.preventDefault();
                });

                function onMouseMove(e) {
                    if (!isResizing) return;
                    const newWidth = startWidth + (e.pageX - startX);
                    th.style.width = newWidth + 'px';
                }

                function onMouseUp() {
                    isResizing = false;
                    document.documentElement.removeEventListener('mousemove', onMouseMove);
                    document.documentElement.removeEventListener('mouseup', onMouseUp);
                }

                th.appendChild(resizer);
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    applyFiltersAndPagination(); // Re-apply both after page change
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalVisibleRows = Array.from(document.querySelectorAll('#reportTableBody tr'))
                                              .filter(row => row.style.display !== 'none' || row.classList.contains('paginated-hidden')).length;
                const totalPages = Math.ceil(totalVisibleRows / rowsPerPage);

                if (currentPage < totalPages) {
                    currentPage++;
                    applyFiltersAndPagination(); // Re-apply both after page change
                }
            });
        });

        // This parseJsonSafely function is not used in dashboard.html directly,
        // but it's part of your previous context, so keeping it.
        function parseJsonSafely(elementId) {
            const element = document.getElementById(elementId);
            if (element && element.textContent) {
                try {
                    return JSON.parse(element.textContent);
                } catch (e) {
                    console.error(`Error parsing JSON from ${elementId}:`, e);
                    return [];
                }
            }
            return [];
        }

        let currentPage = 1;
        const rowsPerPage = 10;
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let isResizing = false;
        let allTableRows = []; // To store all rows initially

        // Function to combine filtering and pagination logic
        function applyFiltersAndPagination() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const allRows = Array.from(document.querySelectorAll('#reportTableBody tr'));
            let visibleRowsAfterFilter = [];

            allRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = false;

                // Check against all relevant cell contents for search
                if (cells.length > 3 && // Ensure cells exist before accessing
                    (cells[0].textContent.toLowerCase().includes(searchInput) || // Type
                     cells[1].textContent.toLowerCase().includes(searchInput) || // Location
                     cells[2].textContent.toLowerCase().includes(searchInput) || // Date
                     cells[3].textContent.toLowerCase().includes(searchInput))) { // Status
                    match = true;
                } else if (cells.length === 1 && cells[0].textContent.toLowerCase().includes("no crime reports")) {
                    // Always show "No crime reports yet." message if it exists
                    match = true;
                }

                // If a row matches the filter, add it to the filtered set
                if (match) {
                    row.classList.remove('filtered-hidden'); // Remove hidden class if it matches
                    visibleRowsAfterFilter.push(row);
                } else {
                    row.classList.add('filtered-hidden'); // Add a class to mark as hidden by filter
                }
            });

            // Now apply pagination to the filtered/visible set of rows
            paginateRows(visibleRowsAfterFilter);
            updateReportCount(); 
        }

        function paginateRows(rowsToPaginate) {
            const totalRows = rowsToPaginate.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            // Ensure current page doesn't exceed new total pages
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1; 
            }

            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`; 

            rowsToPaginate.forEach((row, index) => {
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;

                if (index >= startIndex && index < endIndex) {
                    row.classList.remove('paginated-hidden'); 
                    row.style.display = ''; // Make visible
                } else {
                    row.classList.add('paginated-hidden'); 
                    row.style.display = 'none'; // Hide
                }
            });

            
            const allRows = Array.from(document.querySelectorAll('#reportTableBody tr'));
            allRows.forEach(row => {
                if (row.classList.contains('filtered-hidden') || row.classList.contains('paginated-hidden')) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });

            // Update pagination button states
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages || totalPages === 0;
        }


        function updateReportCount() {
            const visibleRows = Array.from(document.querySelectorAll('#reportTableBody tr'))
                                      .filter(row => row.style.display !== 'none' || row.classList.contains('paginated-hidden')).length;
            document.getElementById('reportCount').textContent = `${visibleRows} report${visibleRows !== 1 ? 's' : ''}`;
        }

        function printReport() {
            window.print();
        }

        function exportToCSV() {
            const table = document.getElementById('reportTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvContent = "data:text/csv;charset=utf-8," +
                rows.map(row => 
                    Array.from(row.querySelectorAll('th, td'))
                        .map(cell => cell.innerText.replace(/\n/g, " ").replace(/,/g, ";"))
                        .join(",")
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "crime_reports.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function sortTable(columnIndex) {
            if (isResizing) return;
            
            const table = document.getElementById('reportTable');
            const rows = Array.from(table.querySelectorAll('tbody tr')); 
            
            const direction = (currentSortColumn === columnIndex && currentSortDirection === 'asc') ? 'desc' : 'asc';
            
            rows.sort((a, b) => {
                const aVal = a.querySelectorAll('td')[columnIndex].textContent.trim();
                const bVal = b.querySelectorAll('td')[columnIndex].textContent.trim();
                
                if (columnIndex === 2) { // Date column sorting
                    const dateA = new Date(aVal);
                    const dateB = new Date(bVal);
                    return direction === 'asc' ? dateA - dateB : dateB - dateA;
                }
                
            
                return direction === 'asc' 
                    ? aVal.localeCompare(bVal, undefined, { numeric: true })
                    : bVal.localeCompare(aVal, undefined, { numeric: true });
            });

            const tbody = table.querySelector('tbody');
            tbody.innerHTML = ''; 
            rows.forEach(row => tbody.appendChild(row)); 
            
            
            document.querySelectorAll('#reportTable th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const header = table.querySelector(`th[data-column="${columnIndex}"]`);
            if (header) { 
                header.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
            
            currentSortColumn = columnIndex;
            currentSortDirection = direction;
            
           
            currentPage = 1; 
            applyFiltersAndPagination();
        }
    </script>
</body>
</html>