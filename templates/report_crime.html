<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Concern</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/rcrime.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <a href="#" class="back-arrow" onclick="history.back()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        </a>

        <div class="header">
            <img src="/static/img/logoss.png" alt="Crime Report Logo" class="logo">
            <h1>Complainant Concerns</h1>
            <p>Help us make your community safer by reporting any incidents.</p>
        </div>

        <div id="flash-messages"></div>

        <form id="reportForm" method="POST" autocomplete="off">
            <div class="form-group">
                <label for="complainant_name">Your Full Name (as registered)</label>
                <input type="text" id="complainant_name" name="complainant_name" placeholder="Enter your full name" required>
                <small id="nameError" class="error-message"></small>
            </div>
            
            <div class="form-group">
                <label for="concern">Concern Details</label>
                <textarea id="concern" name="concern" placeholder="Describe your concern in detail" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="incident_type">Concern Type</label>
                <input type="text" id="incident_type" name="incident_type" class="suggestion-input" placeholder="Start typing to see suggestions" required>
                <div id="suggestions" class="suggestions-container"></div>
            </div>
            
            <div class="form-group">
                <label>Location in Tigbauan</label>
                <div id="map" style="height: 300px; border-radius: 8px; margin-bottom: 10px;"></div>
                <input type="text" id="location" name="location" placeholder="Search location in Tigbauan or click on map" required>
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <button type="button" id="useCurrentLocation" class="location-btn">Use My Current Location</button>
                <small class="location-note">Note: Only locations within Tigbauan area are accepted</small>
            </div>
            
            <div class="form-group">
                <button type="submit" class="submit-btn">Submit Concern</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Tigbauan
        const map = L.map('map').setView([10.6747, 122.3766], 13); // Tigbauan coordinates
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Define Tigbauan boundaries (approximate)
        const tigbauanBounds = L.latLngBounds(
            L.latLng(10.55, 122.25), // Southwest corner
            L.latLng(10.75, 122.45)  // Northeast corner
        );

        // Set max bounds to Tigbauan area
        map.setMaxBounds(tigbauanBounds);
        map.on('drag', function() {
            map.panInsideBounds(tigbauanBounds, { animate: false });
        });

        let marker = null;
        let userLocationMarker = null;

        // Add marker on click
        map.on('click', function(e) {
            if (!tigbauanBounds.contains(e.latlng)) {
                alert('Please select a location within Tigbauan area');
                return;
            }
            
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(e.latlng).addTo(map);
            document.getElementById('latitude').value = e.latlng.lat;
            document.getElementById('longitude').value = e.latlng.lng;
            
            // Reverse geocode to get address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || 'Selected location';
                    document.getElementById('location').value = address;
                });
        });

        // Use current location button
        document.getElementById('useCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const userLocation = L.latLng(lat, lng);
                    
                    if (!tigbauanBounds.contains(userLocation)) {
                        alert('Your current location is outside Tigbauan area. Please select a location within Tigbauan.');
                        return;
                    }
                    
                    if (userLocationMarker) {
                        map.removeLayer(userLocationMarker);
                    }
                    
                    userLocationMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup("Your current location").openPopup();
                    
                    map.setView([lat, lng], 15);
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lng;
                    
                    // Reverse geocode
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                        .then(response => response.json())
                        .then(data => {
                            const address = data.display_name || 'Current location';
                            document.getElementById('location').value = address;
                        });
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });

        // Name validation against user's registered name
        document.getElementById('complainant_name').addEventListener('blur', function() {
            const fullName = this.value.trim();
            if (fullName) {
                axios.get('/validate_name', {
                    params: { full_name: fullName }
                }).then(response => {
                    if (!response.data.valid) {
                        document.getElementById('nameError').textContent = 
                            'Name must match your registered first and last name';
                        document.getElementById('nameError').style.display = 'block';
                    } else {
                        document.getElementById('nameError').style.display = 'none';
                    }
                });
            }
        });

        // Crime type suggestions
        document.getElementById('concern').addEventListener('input', function() {
            const concern = this.value.trim();
            if (concern.length > 10) {  // Only suggest if there's enough text
                axios.post('/get_crime_type_suggestions', { concern: concern })
                    .then(response => {
                        const suggestions = response.data.suggestions;
                        const container = document.getElementById('suggestions');
                        container.innerHTML = '';
                        
                        if (suggestions.length > 0) {
                            suggestions.forEach(suggestion => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.textContent = suggestion;
                                div.onclick = function() {
                                    document.getElementById('incident_type').value = suggestion;
                                    container.style.display = 'none';
                                };
                                container.appendChild(div);
                            });
                            container.style.display = 'block';
                        } else {
                            container.style.display = 'none';
                        }
                    });
            } else {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#suggestions') && e.target.id !== 'incident_type') {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Check name validation
            const nameError = document.getElementById('nameError');
            if (nameError.style.display === 'block') {
                alert('Please correct your name to match your registered account');
                return;
            }
            
            const formData = new FormData(this);
            
            axios.post('/report', formData)
                .then(response => {
                    const flashMessages = document.getElementById('flash-messages');
                    flashMessages.innerHTML = `
                        <div class="alert alert-${response.data.category}">
                            ${response.data.message}
                        </div>
                    `;

                    if (response.data.category === 'success') {
                        document.getElementById('reportForm').reset();
                        if (marker) map.removeLayer(marker);
                        if (userLocationMarker) map.removeLayer(userLocationMarker);
                    }

                    setTimeout(() => {
                        flashMessages.innerHTML = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    const flashMessages = document.getElementById('flash-messages');
                    flashMessages.innerHTML = `
                        <div class="alert alert-danger">
                            Error submitting the form. Please try again.
                        </div>
                    `;
                });
        });
    </script>
</body>
</html>